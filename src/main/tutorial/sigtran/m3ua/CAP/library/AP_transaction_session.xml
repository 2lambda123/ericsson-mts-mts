<?xml version="1.0" encoding="UTF-8"?>
<!-- Related XMLSchema file: conf/schemas/scenario.xsd -->


<!--
    Document   : server.xml
    Created on : 10/07/2014
    Author     : fhenry
    Description: Send a MAP message
-->

<scenario>


    <function name="Manage_identifier">
      <input/>       
      <do>

          <if>
            <condition>
                <test parameter="[testcase:origTransID]" condition="list.exists" not="true"/>
            </condition>
            <then>
                <parameter name="[testcase:origTransID]" operation="binary.random" value="4"/>
            </then>
          </if>    
      
          <if>
            <condition>
                <test parameter="[testcase:destTransID]" condition="list.exists" not="true"/>
            </condition>
            <then>
                <parameter name="[testcase:destTransID]" operation="binary.random" value="4"/>
            </then>
          </if>    
      
          <if>
            <condition>
                <test parameter="[testcase:invokeID]" condition="list.exists"/>
            </condition>
            <then>
                <parameter name="[testcase:invokeID]" operation="number.add" value="[testcase:invokeID]" value2="1"/>
            </then>      
            <else>
                <parameter name="[testcase:invokeID]" operation="set" value="0"/>
            </else>
          </if> 
      </do>      
      <output/>
    </function>
    
    
    <function name="Establish_M3UA_session">
      <input>
        <parameter name="[function:channelName]" type="string"/>       
      </input>
      <do>
         
          <!--if-->
          
          <openChannelSIGTRAN name="[function:channelName]" localHost="[localHostM3UA]" localPort="[localPortM3UA]" 
                              remoteHost="[remoteHostM3UA]" remotePort="[remotePortM3UA]"
                              transport="[transport]"/>

          <sendMessageSIGTRAN	name="Send ASPUP" channel="[function:channelName]">	   
              <UA name="m3ua" file="m3ua.xml">
                  <header 	version="1" reserved="0" messageClass="ASP_State_Maintenance_Messages" messageType="ASP_Up"/>    			
                  <parameter tag="17" >
                      <field name="ASP_Identifier" format="Integer" value="755787" length="4"/>
                  </parameter>
                  <parameter tag="INFO_String">
                      <field name="INFO_String" format="String" value="ASPUP"/>
                  </parameter>
              </UA>
          </sendMessageSIGTRAN>
              
          <receiveMessageSIGTRAN name="Wait ASPUP_ACK" channel="[function:channelName]" 
              request="false" type="ASP_Up:3_1" result="ASP_Up_Acknowledgement:3_4">
              <parameter name="[binary]" operation="protocol.setFromMessage" value="message.binary"/>
          </receiveMessageSIGTRAN>
      
          <sendMessageSIGTRAN	name="Send ASPAC" channel="[function:channelName]">
              <UA name="m3ua" file="m3ua.xml">
                  <header 	version="1" reserved="0" messageClass="ASP_Traffic_Maintenance_Messages" messageType="ASP_Active"/>
          				
                  <parameter tag="17" >
                      <field name="ASP_Identifier" format="Integer" value="755787" length="4"/>
                  </parameter>
          	
                  <parameter tag="INFO_String">
                      <field name="INFO_String" format="String" value="ASPAC"/>
                  </parameter>
              </UA>
          </sendMessageSIGTRAN>
              
          <receiveMessageSIGTRAN name="Wait ASPAC_ACK" channel="[function:channelName]"
              request="false" type="ASP_Active:4_1" result="ASP_Active_Acknowledgement:4_3">
              <parameter name="[binary]" operation="protocol.setFromMessage" value="message.binary"/>
          </receiveMessageSIGTRAN>

      </do>      
      <output/>
    </function>
            

    <function name="Answer_M3UA_session">
      <input/>       
      <do>

          <receiveMessageSIGTRAN name="Wait ASPUP1" request="true" type="ASP_Up:3_1">
              <parameter name="[function:channelName]" operation="protocol.setFromMessage" value="channel.name"/>
              <parameter name="[protocol]" operation="protocol.setFromMessage" value="message.protocol"/>
              <test parameter="[protocol]" condition="string.equals" value="SIGTRAN.M3UA"/>
          </receiveMessageSIGTRAN>
              
          <sendMessageSIGTRAN	name="Send ASPUP1" destScenario="client" channel="[function:channelName]">    
              <UA name="m3ua" file="m3ua.xml">
                  <header version="1" reserved="0" messageClass="ASP_State_Maintenance_Messages" messageType="ASP_Up_Acknowledgement"/>    				
                  <parameter tag="17" >
                      <field name="ASP_Identifier" format="Integer" value="19" length="4"/>
                  </parameter>
                  <parameter tag="INFO_String">
                      <field name="INFO_String" format="String" value="ASPUP_ACK"/>
                  </parameter>
              </UA>
          </sendMessageSIGTRAN>
      
          <receiveMessageSIGTRAN name="Wait ASPAC1" request="true" type="ASP_Active:4_1">
              <parameter name="[channelName]" operation="protocol.setFromMessage" value="channel.name"/>
              <parameter name="[protocol]" operation="protocol.setFromMessage" value="message.protocol"/>
              <test parameter="[protocol]" condition="string.equals" value="SIGTRAN.M3UA"/>
          </receiveMessageSIGTRAN>
          
          <sendMessageSIGTRAN	name="Send ASPAC1" channel="[function:channelName]">
          	<UA name="m3ua" file="m3ua.xml">
              <header messageClass="ASP_Traffic_Maintenance_Messages" messageType="ASP_Active_Acknowledgement"/>
          		<parameter tag="Traffic_Mode_Type">
                  <field name="Traffic_Mode_Type" value="2"/>
              </parameter>
          		<parameter tag="Routing_Context">
          			<field name="Routing_Context" value="7864455"/>
          			<field name="Routing_Context" value="75788"/>
          		</parameter>
          		<parameter tag="INFO_String" format="string">
                <field name="INFO_String" value="ASPAC_ACK"/>
              </parameter>
          	</UA>
          </sendMessageSIGTRAN>


      </do>      
      <output>
        <!--parameter name="[function:channelName]" type="string"/-->
        <parameter name="[function:channelName]"/>        
      </output>
    </function>
                
</scenario>
