<?xml version="1.0" encoding="UTF-8"?>
<!-- Related XMLSchema file: conf/schemas/scenario.xsd -->


<!--
    Document   : server.xml
    Created on : 10/07/2014
    Author     : fhenry
    Description: Send a MAP message
-->

<scenario>

    <function file="library/M3UA_manage_session.xml" />    
    <call name="Establish_M3UA_session" >
        <input>
            <parameter name="[function:channelName]" value="channel"/>        
        </input>
    </call>
	  
    <!--function file="036_ACR_ApplyChargingReport/client.xml" /-->
    
    <call name="Send_036_ACR_ApplyChargingReport" >
        <input>
            <parameter name="[function:channelName]" value="channel"/>        
            <parameter name="[function:legType]" value="1"/>
            <parameter name="[function:timeIfNoTariffSwitch]" value="1000"/>            
        </input>
        <output>
            <!--parameter name="[function:res]" /-->
        </output>
    </call>

    <function name="Send_036_ACR_ApplyChargingReport">
      <input>
        <parameter name="[function:channelName]" type="string"/>       
        <parameter name="[function:legType]" type="number" />
        <parameter name="[function:timeIfNoTariffSwitch]" type="number"/>
      </input>
      <do>

          <call name="Manage_identifier">
          </call>
      
          <parameter name="[invokeID]" operation="number.add" value="[invokeID]" value2="1"/>
          <sendMessageSIGTRAN name="Send DATA1" channel="[function:channelName]">
          
          <!-- AP LAYER -->
          <ASN dictionary="cap/dictionary_CAP.xml">
            <Component.Choice>
              <invoke.C1.Sequence>
                 <invokeID.BoxedType><Integer>[invokeID]</Integer></invokeID.BoxedType>
                 <!--linkedID.C0.BoxedType><Integer>634421171</Integer></linkedID.C0.BoxedType-->
                 <opCode.Choice>
                    <localValue.BoxedType><Long>applyChargingReport:36</Long></localValue.BoxedType>
                    <!--globalValue><ObjectIdentifier>0.1.2112.84.58.65.40</ObjectIdentifier></globalValue-->
                 </opCode.Choice>
                 <invokeparameter>
                    <ApplyChargingReportArg.BoxedType>
                      <CallResult.BoxedType>
                      <!--Bytes>7d52f04f3e671dbfdf</Bytes-->
                      <CAMEL_CallResult.Choice><timeDurationChargingResult.C0.Sequence>
                               <partyToCharge.C0.Choice><receivingSideID.C1.BoxedType><Bytes>06
                                        <field name="LegType" value="[function:legType]" type="EnumLong" length="1"/>
                                     </Bytes></receivingSideID.C1.BoxedType></partyToCharge.C0.Choice>
                               <timeInformation.C1.Choice>
                                  <timeIfNoTariffSwitch.C0.BoxedType><Integer>[function:timeIfNoTariffSwitch]</Integer></timeIfNoTariffSwitch.C0.BoxedType>
                                  <!--timeIfTariffSwitch.C1.Sequence>
                                     <timeSinceTariffSwitch.C0>2</timeSinceTariffSwitch.C0>
                                     <tariffSwitchInterval.C1>2</tariffSwitchInterval.C1>
                                  </timeIfTariffSwitch.C1.Sequence-->
                               </timeInformation.C1.Choice>
                               <legActive.C2d>false:0</legActive.C2d>
                               <!--callLegReleasedAtTcpExpiry.C3></callLegReleasedAtTcpExpiry.C3-->
                               <!--extensions.C4.BoxedType>
                                  <Collection>
                                     <ExtensionField.Sequence>
                                        <type.Choice>
                                           <local>1087466306</local>
                                           <global><ObjectIdentifier>0.1.258.93.3.103.3.56.118.126</ObjectIdentifier></global>
                                        </type.Choice>
                                        <criticality.nulld.Enum>
                                           <EnumType>abort.1</EnumType>
                                        </criticality.nulld.Enum>
                                        <NullObject.C1></NullObject.C1>
                                     </ExtensionField.Sequence>
                                     <ExtensionField.Sequence>
                                        <type.Choice>
                                           <local>1249932232</local>
                                           <global><ObjectIdentifier>0.1.229</ObjectIdentifier></global>
                                        </type.Choice>
                                        <criticality.nulld.Enum>
                                           <EnumType>abort.1</EnumType>
                                        </criticality.nulld.Enum>
                                        <NullObject.C1></NullObject.C1>
                                     </ExtensionField.Sequence>
                                     <ExtensionField.Sequence>
                                        <type.Choice>
                                           <local>788626000</local>
                                           <global><ObjectIdentifier>0.1.234.68.122.126.101.89.128</ObjectIdentifier></global>
                                        </type.Choice>
                                        <criticality.nulld.Enum>
                                           <EnumType>abort.1</EnumType>
                                        </criticality.nulld.Enum>
                                        <NullObject.C1></NullObject.C1>
                                     </ExtensionField.Sequence>
                                  </Collection>
                               </extensions.C4.BoxedType-->
                               <!--aChChargingAddress.C5d.Choice>
                                  <legID.C2.Choice>
                                     <sendingSideID.C0.BoxedType><Bytes>02
                                           <field name="LegType" value="leg2 LegType:2" type="EnumLong" length="1"/>
                                        </Bytes></sendingSideID.C0.BoxedType>
                                     <receivingSideID.C1.BoxedType><Bytes>02
                                           <field name="LegType" value="leg2 LegType:2" type="EnumLong" length="1"/>
                                        </Bytes></receivingSideID.C1.BoxedType>
                                  </legID.C2.Choice>
                                  <srfConnection.C50.BoxedType><Integer>1</Integer></srfConnection.C50.BoxedType>
                               </aChChargingAddress.C5d.Choice-->
                            </timeDurationChargingResult.C0.Sequence></CAMEL_CallResult.Choice>
                      </CallResult.BoxedType>
                 </ApplyChargingReportArg.BoxedType>
                 </invokeparameter>
              </invoke.C1.Sequence>
            </Component.Choice>
          </ASN>
          
          <!-- TCAP LAYER -->
          <ASN dictionary="tcap/dictionary_TCAP.xml">
            <TCMessage.Choice>
              <continue1.A5.Sequence>
                <otid.BoxedType><Bytes>[origTransID]</Bytes></otid.BoxedType>
                <dtid.BoxedType><Bytes>[destTransID]</Bytes></dtid.BoxedType>
                <!--dialoguePortion.BoxedType>
                  <DialogueOC.A11.BoxedType>
                    <ExternalPDU.A11.BoxedType>
                      <ExternalPDUSequenceType.U8.Sequence>
                        <direct_reference><ObjectIdentifier>dialogue-as-id:0.0.17.773.1.1.1</ObjectIdentifier></direct_reference>
                        <encoding.Choice>
                          <single_ASN1_type.C0.BoxedType>
                            <DialoguePDU.Choice>
                              <dialogueResponse.A1.BoxedType>
                                <AARE_apduSequenceType.A1.Sequence>
                                  <protocol_version.C0d><BitString value="Version1:80" trailing="7"/></protocol_version.C0d>
                                  <application_context_name.C1.BoxedType>
                                    <ObjectIdentifier><ObjectIdentifier>CAP-v2-gsmSSF-to-gsmSCF-AC:0.4.0.0.1.0.50.1</ObjectIdentifier></ObjectIdentifier>
                                  </application_context_name.C1.BoxedType>
                                  <result.C2.BoxedType>
                                    <Associate_result.C2.BoxedType><Long>0</Long></Associate_result.C2.BoxedType>
                                  </result.C2.BoxedType>
                                  <result_source_diagnostic.C3.BoxedType>
                                    <Associate_source_diagnostic.C3.Choice>
                                      <dialogue_service_user.C1.BoxedType>
                                        <Dialogue_service_user.C1.BoxedType><Long>0</Long></Dialogue_service_user.C1.BoxedType>
                                      </dialogue_service_user.C1.BoxedType>
                                    </Associate_source_diagnostic.C3.Choice>
                                  </result_source_diagnostic.C3.BoxedType>
                                </AARE_apduSequenceType.A1.Sequence>
                              </dialogueResponse.A1.BoxedType>
                            </DialoguePDU.Choice>
                          </single_ASN1_type.C0.BoxedType>
                        </encoding.Choice>
                      </ExternalPDUSequenceType.U8.Sequence>
                    </ExternalPDU.A11.BoxedType>
                  </DialogueOC.A11.BoxedType>
                </dialoguePortion.BoxedType-->
              </continue1.A5.Sequence>
            </TCMessage.Choice>
          </ASN>
          
      	  <!-- SCCP LAYER  -->
        	<SS7 name="sccp" file="sccp.xml">
        		<header>
                <field name="Message_Type" length="1" value="9" /> <!-- code for UnitData is 9 -->
            </header>
        		<parameter name="Protocol_Class" type="F" littleEndian="false">
        			<field value="0" lengthBit="4" />
        			<field value="1" lengthBit="4" /> <!-- values 0 and 1 is for connectionless class protocol, values 2 and 3 are for connection-oriented-protocol -->
        		</parameter>
          	<parameter id="3" name="Called_Party_Address" type="V" littleEndian="false">
          	    <!--field name="Address_Indicator" value="18" format="integer" length="1" />
          	    <field name="Signalling_Point_Code" value="[M3UA_DPC]" length="2" />
          	    <field name="Subsystem_Number" value="[SCCP_DSSN]" length="1" /-->	
                <field name="Global_Title" value="1292001104[SCCP_DGT]" format="binary" length="11"/>
          	</parameter>	
          	<parameter id="4" type="V" name="Calling_Party_Address" littleEndian="false">
          	    <!--field name="Address_Indicator" value="18" format="integer" length="1" />
          	    <field name="Signalling_Point_Code" value="[M3UA_OPC]" length="2" />
          	    <field name="Subsystem_Number" value="[SCCP_OSSN]" length="1" /-->
        	      <field name="Global_Title" value="1292001104[SCCP_OGT]" format="binary" length="11" />
          	</parameter>
        		<parameter id="15" name="Data" type="V" littleEndian="false"/>
        			<!--field value="" format="binary" length="88" />
              <field value="625a4804000000016b1e281c060700118605010101a011600f80020780a1090607040000010015026c32a13002010102012e30288407913366600567f98207913366317071f3041411080b913366600567f70000a906f3f97c3e9f03" format="binary" length="92" /> 
        		</parameter-->
        	</SS7>
      
          <UA name="m3ua" file="m3ua.xml">
              <header	messageClass="Transfer_Messages" messageType="Payload_Data"/>
      				
              <parameter tag="Network_Appearence">
                  <field name="Network_Appearence"  format="Integer" value="102"/>
              </parameter>
      
      
              <parameter tag="Routing_Context">
                  <field name="Routing_Context" format="Integer"  value="101"/>
              </parameter>
      
              <parameter tag="Protocol_Data">
                  <field value="[M3UA_OPC]" name="Originating_Point_Code"/>
                  <field value="[M3UA_OPC]" name="Destination_Point_Code" />
                  <field value="SCCP"	name="SI"/>
                  <field value="2"	name="NI"/>
                  <field value="0"	name="MP"/>
                  <field value="1"	name="SLS"/>
                  <field name="DATA"	format="fvo"/>
              </parameter>
      	
              <parameter tag="Correlation_Id">
                  <field name="Correlation_Id" format="Integer"  value="12783"/>
              </parameter>
          </UA>
          </sendMessageSIGTRAN>
      
          <!--receiveMessageSIGTRAN name="Wait DATA1" channel="channel" request="false" type="applyChargingReport:36" result="RESULT">
              <parameter name="[data1]" operation="protocol.setFromMessage" value="message.binary"/>
          </receiveMessageSIGTRAN-->

      </do>      
      <output>
          <!--parameter name="[function:res]" /-->
      </output>
    </function>            

    <!-- remove pb of TIME_WAIT state -->
    <!--closeChannelSIGTRAN name="channel"/-->
    <pause name="wait a while" seconds="0.1"/>
                
</scenario>
