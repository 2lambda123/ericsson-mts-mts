<?xml version="1.0" encoding="UTF-8"?>
<!-- Related XMLSchema file: conf/schemas/scenario.xsd -->


<!--
    Document   : server.xml
    Created on : 10/07/2014
    Author     : fhenry
    Description: Send a MAP message
-->

<scenario>

    <!--openChannelSIGTRAN name="channel" localHost="[localHostM3UA]" localPort="[localPortM3UA]" 
                                       remoteHost="[remoteHostM3UA]" remotePort="[remotePortM3UA]"
                                       transport="[transport]"/-->
                                       
    <receiveMessageSIGTRAN name="Wait ASPUP1" request="true" type="ASP_Up:3_1">
        <parameter name="[channelName]" operation="protocol.setFromMessage" value="channel.name"/>
        <parameter name="[protocol]" operation="protocol.setFromMessage" value="message.protocol"/>
        <test parameter="[protocol]" condition="string.equals" value="SIGTRAN.M3UA"/>
    </receiveMessageSIGTRAN>
        
    <sendMessageSIGTRAN	name="Send ASPUP1" destScenario="client" channel="[channelName]">    
        <UA name="m3ua" file="m3ua.xml">
            <header version="1" reserved="0" messageClass="ASP_State_Maintenance_Messages" messageType="ASP_Up_Acknowledgement"/>    				
            <parameter tag="17" >
                <field name="ASP_Identifier" format="Integer" value="19" length="4"/>
            </parameter>
            <parameter tag="INFO_String">
                <field name="INFO_String" format="String" value="ASPUP_ACK"/>
            </parameter>
        </UA>
    </sendMessageSIGTRAN>

    <receiveMessageSIGTRAN name="Wait ASPAC1" request="true" type="ASP_Active:4_1">
        <parameter name="[channelName]" operation="protocol.setFromMessage" value="channel.name"/>
        <parameter name="[protocol]" operation="protocol.setFromMessage" value="message.protocol"/>
        <test parameter="[protocol]" condition="string.equals" value="SIGTRAN.M3UA"/>
    </receiveMessageSIGTRAN>
    
    <sendMessageSIGTRAN	name="Send ASPAC1" channel="[channelName]">
    	<UA name="m3ua" file="m3ua.xml">
        <header messageClass="ASP_Traffic_Maintenance_Messages" messageType="ASP_Active_Acknowledgement"/>
    		<parameter tag="Traffic_Mode_Type">
            <field name="Traffic_Mode_Type" value="2"/>
        </parameter>
    		<parameter tag="Routing_Context">
    			<field name="Routing_Context" value="7864455"/>
    			<field name="Routing_Context" value="75788"/>
    		</parameter>
    		<parameter tag="INFO_String" format="string">
          <field name="INFO_String" value="ASPAC_ACK"/>
        </parameter>
    	</UA>
    </sendMessageSIGTRAN>
       
    <if>
      <condition>
          <test parameter="[testcase:origTransID]" condition="list.exists" not="true"/>
      </condition>
      <then>
          <parameter name="[testcase:origTransID]" operation="binary.random" value="4"/>
      </then>
    </if>    

    <if>
      <condition>
          <test parameter="[testcase:destTransID]" condition="list.exists" not="true"/>
      </condition>
      <then>
          <parameter name="[testcase:destTransID]" operation="binary.random" value="4"/>
      </then>
    </if>    

    <if>
      <condition>
          <test parameter="[testcase:invokeID]" condition="list.exists"/>
      </condition>
      <then>
          <parameter name="[testcase:invokeID]" operation="number.add" value="[testcase:invokeID]" value2="1"/>
      </then>      
      <else>
          <parameter name="[testcase:invokeID]" operation="set" value="1"/>
      </else>
    </if>    


    <function file="000_IDP_InitialDetectionPoint/client.xml" />
    
    <call name="Send_000_IDP_InitialDetectionPoint" >
        <input>
            <parameter name="[function:channelName]" value="[channelName]"/>        
            <parameter name="[function:callingPartyNumber]" value="33867801023"/>
            <parameter name="[function:calledPartyBCDNumber]" value="3328707690265"/>
            <parameter name="[function:vlr_number]" value="33771092331"/>
        </input>
        <output>
            <!--parameter name="[function:res]" /-->
        </output>
    </call>

    <receiveMessageSIGTRAN name="Wait DATA1" request="true" type="requestReportBCSMEvent:23">
        <parameter name="[protocol]" operation="protocol.setFromMessage" value="message.protocol"/>
        <test parameter="[protocol]" condition="string.equals" value="SIGTRAN.CAP"/>
        <parameter name="[channelName]" operation="protocol.setFromMessage" value="channel.name"/>
        <parameter name="[request]" operation="protocol.setFromMessage" value="message.request"/>
        <parameter name="[type]" operation="protocol.setFromMessage" value="message.type"/>
        <parameter name="[result]" operation="protocol.setFromMessage" value="message.result"/>         
        <parameter name="[origTransID]" operation="protocol.setFromMessage" value="tcap.continue1.otid"/>
        <parameter name="[destTransID]" operation="protocol.setFromMessage" value="tcap.continue1.dtid"/>                
    </receiveMessageSIGTRAN>

    <receiveMessageSIGTRAN name="Wait DATA1" request="true" type="requestReportBCSMEvent:23">
        <parameter name="[protocol]" operation="protocol.setFromMessage" value="message.protocol"/>
        <test parameter="[protocol]" condition="string.equals" value="SIGTRAN.CAP"/>
        <parameter name="[channelName]" operation="protocol.setFromMessage" value="channel.name"/>
        <parameter name="[request]" operation="protocol.setFromMessage" value="message.request"/>
        <parameter name="[type]" operation="protocol.setFromMessage" value="message.type"/>
        <parameter name="[result]" operation="protocol.setFromMessage" value="message.result"/>         
        <parameter name="[origTransID]" operation="protocol.setFromMessage" value="tcap.continue1.otid"/>
        <parameter name="[destTransID]" operation="protocol.setFromMessage" value="tcap.continue1.dtid"/>                
    </receiveMessageSIGTRAN>

    <function file="024_ERB_EventReportBSCM/client.xml" />  
    <call name="Send_024_ERB_EventReportBSCM" >
        <input>
            <parameter name="[function:channelName]" value="[channelName]"/>        
            <parameter name="[function:eventTypeBCSM]" value="oAnswer.7"/>
            <parameter name="[function:legType]" value="02"/>
            <parameter name="[function:oDisconnectSpecificInfo_causeValue]" value="Class 001 normal event : Normal call clearing:16"/> 
        </input>
        <output>
            <!--parameter name="[function:res]" /-->
        </output>
    </call>
    
   <receiveMessageSIGTRAN name="Wait DATA1" request="true" type="applyCharging:35">
       <parameter name="[channelName]" operation="protocol.setFromMessage" value="channel.name"/>
       <parameter name="[protocol]" operation="protocol.setFromMessage" value="message.protocol"/>
       <test parameter="[protocol]" condition="string.equals" value="SIGTRAN.CAP"/>
       <parameter name="[request]" operation="protocol.setFromMessage" value="message.request"/>
       <parameter name="[type]" operation="protocol.setFromMessage" value="message.type"/>
       <parameter name="[result]" operation="protocol.setFromMessage" value="message.result"/>
       <parameter name="[invokeID]" operation="protocol.setFromMessage" value="asn.Component.invoke.invokeID"/>         
       <parameter name="[origTransID]" operation="protocol.setFromMessage" value="tcap.continue1.otid"/>
       <parameter name="[destTransID]" operation="protocol.setFromMessage" value="tcap.continue1.dtid"/>                
    </receiveMessageSIGTRAN>
        
    <pause seconds="0.1"/>

    <function file="036_ACR_ApplyChargingReport/client.xml" />
    
    <call name="Send_036_ACR_ApplyChargingReport" >
        <input>
            <parameter name="[function:channelName]" value="[channelName]"/>        
            <parameter name="[function:legType]" value="1"/>
            <parameter name="[function:timeIfNoTariffSwitch]" value="10"/>            
        </input>
        <output>
            <!--parameter name="[function:res]" /-->
        </output>
    </call>     
    
    <call name="Send_024_ERB_EventReportBSCM" >
        <input>
            <parameter name="[function:channelName]" value="[channelName]"/>        
            <parameter name="[function:eventTypeBCSM]" value="oDisconnect.9"/>
            <parameter name="[function:legType]" value="02"/>            
            <parameter name="[function:oDisconnectSpecificInfo_causeValue]" value="Class 001 normal event : Normal call clearing:16"/>            
        </input>
        <output>
            <!--parameter name="[function:res]" /-->
        </output>
    </call>
    
   <receiveMessageSIGTRAN name="Wait DATA1" request="true" type="cancel:53">
       <parameter name="[channelName]" operation="protocol.setFromMessage" value="channel.name"/>
       <parameter name="[protocol]" operation="protocol.setFromMessage" value="message.protocol"/>
       <test parameter="[protocol]" condition="string.equals" value="SIGTRAN.CAP"/>
       <parameter name="[request]" operation="protocol.setFromMessage" value="message.request"/>
       <parameter name="[type]" operation="protocol.setFromMessage" value="message.type"/>
       <parameter name="[result]" operation="protocol.setFromMessage" value="message.result"/>
       <parameter name="[invokeID]" operation="protocol.setFromMessage" value="asn.Component.invoke.invokeID"/>         
       <parameter name="[origTransID]" operation="protocol.setFromMessage" value="tcap.continue1.otid"/>
       <parameter name="[destTransID]" operation="protocol.setFromMessage" value="tcap.continue1.dtid"/>                
    </receiveMessageSIGTRAN>
            
    <!-- remove pb of TIME_WAIT state -->
    <!--closeChannelSIGTRAN name="channel"/-->
    <pause name="wait a while" seconds="0.1"/>
                
</scenario>
